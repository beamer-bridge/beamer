name: Agent Packaging

on:
  push:
    tags:
      - '*'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


jobs:
  prepare-package:
    uses: ./.github/workflows/prepare-package.yml

  package:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: prepare-package

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'false'

      - uses: actions/download-artifact@v3
        with:
          name: relayers

      - uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - uses: Gr1N/setup-poetry@v7

      - name: Cache Python packages
        id: cache-python-packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: poetry-${{ runner.os }}-${{ hashFiles('.github/workflows/agent-release.yml', 'poetry.lock') }}

      - name: Build agent package
        run: |
          mkdir -p beamer/data/relayers
          mv relayer-node16-* beamer/data/relayers
          poetry install
          poetry build
          poetry publish -u '__token__' -p ${{ secrets.PIP_PASSWORD }}
