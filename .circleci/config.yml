version: 2.1

executors:
  python:
    docker:
      - image: cimg/python:3.9.13
    working_directory: ~/beamer

  node:
    docker:
      - image: cimg/node:16.16
    working_directory: ~/beamer

jobs:
  checkout:
    executor: python
    steps:
      - checkout
      - persist_to_workspace:
          root: "~"
          paths:
            - beamer

  install-python:
    executor: python
    environment:
      SHELL: "/bin/bash"
    steps:
      - attach_workspace:
          at: "~"
      - run: pip install -U poetry
      - restore_cache:
          keys:
            - beamer-dependencies-v1-{{ checksum "poetry.lock" }}
            - beamer-dependencies-v1
      - run: poetry install
      - save_cache:
          key:
            beamer-dependencies-v1-{{ checksum "poetry.lock" }}
          paths:
            - "~/.cache/pypoetry/virtualenvs"
      - persist_to_workspace:
          root: "~"
          paths:
            - ".cache/pypoetry/virtualenvs"

  create-relayers:
    executor: node
    steps:
      - attach_workspace:
          at: "~"
      - run: make relayers
      - persist_to_workspace:
          root: "."
          paths:
            - "relayer"

  install-npm-packages:
    executor: node
    steps:
      - attach_workspace:
          at: "~"
      - run: npm install prettier prettier-plugin-solidity --location=global
      - run: npm install solhint --location=global
      - run: npm install ganache --location=global
      - persist_to_workspace:
          root: "~"
          paths:
            - ".nvm"
